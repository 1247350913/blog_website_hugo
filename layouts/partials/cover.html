{{- $IsHome := .IsHome }}

{{- with .cxt}} {{/* Apply proper context from dict */}}
{{- if .Params.cover.image }}

{{- $sizes := (slice "360" "480" "720" "1080" "1500") }}

{{- $file := (.Page.Resources.ByType "image").GetMatch (printf "*%s*" (.Params.cover.image)) }}
{{- if not (isset $file "Width") }}{{ $file = false }}{{ end }} {{/* Exception for non-supported images */}}

{{- $src := cond (default true .Site.Params.responsiveImages) $file false }}
{{- $fallback := cond (default false .Params.cover.relative) (path.Join .RelPermalink .Params.cover.image) (.Params.cover.image) -}}

{{- $addLink := and (not $IsHome) (default true .Site.Params.linkFullImages) -}}
{{- $responsiveImg := and $src (default false .Params.cover.relative) -}}

<figure class="entry-cover">  
{{- if $responsiveImg -}}
    {{- if $addLink }}<a href="{{ $src.Permalink }}" target="_blank" 
        {{- with .Params.cover.caption }}title="{{ . | plainify }}"{{ else }}{{ with .Params.cover.alt }}title="{{ . | plainify }}"{{ end }}{{ end }}>
    {{- end }}
    <img sizes="(min-width: 768px) 720px, 100vw"
    srcset='{{- range $sizes -}}
        {{ if ge $src.Width . }}{{ ($src.Resize (printf "%sx" .)).Permalink }} {{ (printf "%sw" .) }},{{ end }}
    {{- end -}} {{$src.Permalink }} {{printf "%dw" ($src.Width)}}'
    {{- if ge $src.Width "720" }}src="{{ ($src.Resize "720x").Permalink }}"
    {{- else }}src="{{ $src.Permalink }}" {{ end }}{{ with .Params.cover.alt }} alt="{{ . | plainify }}"{{ end }}>
    
{{- else }}{{/* Fall back to full image */}}
    {{- if $addLink }}<a href="{{ $fallback | absURL }}" target="_blank" 
        {{- with .Params.cover.caption }}title="{{ . | plainify }}"{{ else }}{{ with .Params.cover.alt }}title="{{ . | plainify }}"{{ end }}{{ end }}>
    {{- end }}
    <img src="{{ $fallback | absURL }}" {{ with .Params.cover.alt }} alt="{{ . | plainify }}"{{ end }}>
{{- end }}

{{- if not $IsHome -}} {{- if $addLink }}</a>{{ end -}}
  <p>{{.Params.cover.caption | markdownify }}</p>
{{- end }}
</figure>

{{- end }}{{/* End image */}}
{{- end -}}{{/* End context */}}
