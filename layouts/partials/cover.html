{{- $IsHome := .IsHome }}

{{- with .cxt}} {{/* Apply proper context from dict */}}
{{- if .Params.cover.image }}

{{- $sizes := (slice "480" "720" "1080" "1500") }}

{{- $src := .Page.Resources.GetMatch (printf "*%s*" (.Params.cover.image)) }}
{{- $fallback := cond .Params.cover.relative (path.Join .RelPermalink .Params.cover.image) (.Params.cover.image) -}}

{{- $addLink := and (not $IsHome) (default true .Site.Params.linkFullImages) -}}

<figure class="entry-cover">  
{{- if and $src .Params.cover.relative -}}
    {{- if $addLink }}<a href="{{ $src.RelPermalink }}" target="_blank" title="Original image">{{ end }}
    <img sizes="(min-width: 768px) 720px, 100vw"
    srcset='{{- range $sizes -}}
        {{ if ge $src.Width . }}{{ ($src.Resize (printf "%sx" .)).RelPermalink }} {{ (printf "%sw" .) }},{{ end }}
    {{- end -}} {{$src.RelPermalink}} {{printf "%dw" ($src.Width)}}'
    {{- if ge $src.Width "720" }}src="{{ ($src.Resize "720x").RelPermalink }}"
    {{- else }}src="{{ $src.RelPermalink }}" {{ with .Params.cover.alt }} alt="{{ . | plainify }}"{{ end }}{{ end }}>
    
{{- else }}{{/* Fall back to full image */}}
    {{- if $addLink }}<a href="{{ $fallback | absURL }}" target="_blank" title="Original image">{{ end }}
    <img src="{{ $fallback | absURL }}" {{ with .Params.cover.alt }} alt="{{ . | plainify }}"{{ end }}>
{{- end }}

{{- if not $IsHome -}} {{- if $addLink }}</a>{{ end -}}
  <p>{{.Params.cover.caption | markdownify }}</p>
{{- end }}
</figure>

{{- end }}{{/* End image */}}
{{- end -}}{{/* End context */}}
